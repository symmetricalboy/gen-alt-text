var bskyaltgenerator=function(){"use strict";var J=Object.defineProperty;var K=(x,y,m)=>y in x?J(x,y,{enumerable:!0,configurable:!0,writable:!0,value:m}):x[y]=m;var w=(x,y,m)=>K(x,typeof y!="symbol"?y+"":y,m);var V,U;function x(d){return d}const m=(U=(V=globalThis.browser)==null?void 0:V.runtime)!=null&&U.id?globalThis.browser:globalThis.chrome,z={matches:["*://*.bsky.app/*"],main(){if(console.log("Bluesky Alt Text Generator loaded"),typeof window>"u"||typeof document>"u")return;const o=['textarea[aria-label="Alt text"]','textarea[placeholder*="alt"]','textarea[placeholder*="Alt"]','textarea[data-testid*="alt"]','[role="textbox"][aria-label*="alt" i]'].join(","),s="gemini-alt-text-button",u='[data-testid="composer"]',E='input[type="file"][aria-label*="media" i]',T=u;let f={autoMode:!1,showToasts:!0};async function k(){try{const t=await m.storage.local.get(["autoMode","showToasts"]);t&&(f={...f,...t}),console.log("Loaded config:",f)}catch(t){console.error("Error loading config from storage:",t)}}k(),m.storage.onChanged.addListener((t,a)=>{if(a==="local"){let c=!1;t.autoMode&&(f.autoMode=t.autoMode.newValue,c=!0),t.showToasts&&(f.showToasts=t.showToasts.newValue,c=!0),c&&console.log("Updated config via storage listener:",f)}});const q=t=>{if(!(!t||t.length===0)){console.log(`Intercepted ${t.length} file(s)`);for(const a of t){if(!a.type.startsWith("image/")&&!a.type.startsWith("video/")){console.log(`Skipping non-media file: ${a.name} (${a.type})`);continue}const c=new FileReader;c.onload=i=>{var e;const r=(e=i.target)==null?void 0:e.result;typeof r=="string"?(console.log(`Read file ${a.name} (${a.type}), sending to background...`),m.runtime.sendMessage({type:"MEDIA_INTERCEPTED",payload:{filename:a.name,filetype:a.type,dataUrl:r,size:a.size}}).then(n=>{console.log("Background script responded to MEDIA_INTERCEPTED:",n)}).catch(n=>{console.error("Error sending MEDIA_INTERCEPTED message or receiving response:",n)}),f.showToasts&&_(`Captured ${a.name}`,"info",2e3)):console.error(`Failed to read file ${a.name} as Base64 Data URL.`)},c.onerror=i=>{console.error(`Error reading file ${a.name}:`,i)},c.readAsDataURL(a)}}},_=(t,a="info",c=5e3)=>{let i=document.getElementById("gemini-toast-container");i||(i=document.createElement("div"),i.id="gemini-toast-container",Object.assign(i.style,{position:"fixed",bottom:"20px",right:"20px",zIndex:"10000",display:"flex",flexDirection:"column",gap:"10px"}),document.body.appendChild(i));const r=document.createElement("div");Object.assign(r.style,{padding:"12px 16px",borderRadius:"6px",boxShadow:"0 2px 8px rgba(0, 0, 0, 0.15)",margin:"5px",minWidth:"200px",color:"#ffffff",fontSize:"14px",transition:"all 0.3s ease"});const e={success:"#1da882",error:"#e53935",warning:"#f59f0b",info:"#007eda"};r.style.backgroundColor=e[a]||e.info,r.textContent=t;const n=document.createElement("span");n.textContent="×",Object.assign(n.style,{marginLeft:"8px",cursor:"pointer",float:"right",fontWeight:"bold"}),n.onclick=()=>{r.parentNode===i&&i.removeChild(r)},r.appendChild(n),i.appendChild(r),setTimeout(()=>{r.parentNode===i&&i.removeChild(r)},c)},X=t=>{console.log("Searching for media in container:",t);const a=n=>{if(!n)return!1;const l=n.getBoundingClientRect();return l.width>10&&l.height>10&&n.offsetParent!==null},c=['[data-testid="imagePreview"] img[src^="data:image/"]','[data-testid="images"] img[src^="data:image/"]','[data-testid="imagePreview"] img[src^="blob:"]','[data-testid="images"] img[src^="blob:"]','img[src^="data:image/"]','img[src^="blob:"]'];for(const n of c){const l=t.querySelector(n);if(a(l))return console.log(`Found image via selector: ${n}`,l),l;l&&console.warn(`Image found but hidden/too small with selector: ${n}`,l)}console.log("No valid data/blob URL image found via direct selectors, proceeding to scoring logic...");const i=Array.from(t.querySelectorAll("img, video"));let r=null,e=-1;for(const n of i){let l=0;const p=n.getBoundingClientRect();if(a(n)){if(n instanceof HTMLVideoElement)if(n.src||n.querySelector("source[src]"))l=1e3;else continue;else if(n instanceof HTMLImageElement){const h=n,g=h.src||"",M=h.alt||"";if(!g||g.startsWith("data:")||g.startsWith("blob:")||M.toLowerCase().includes("avatar")||g.includes("avatar")||g.includes("profile"))continue;const L=50;if(p.width<L||p.height<L)continue;l=1,console.log(`Valid scoring candidate: ${p.width}x${p.height}`,h),h.closest('[data-testid="imagePreview"], .r-1p0dtai[style*="aspect-ratio"]')&&(l+=500),l<=1&&h.matches('[data-testid*="image"], [data-testid*="preview"], [role="img"]')&&(l+=50);const b=h.closest('[data-testid="postView"], [role="article"]'),v=t instanceof Element?t.closest('[data-testid="postView"], [role="article"]'):null;b&&v&&b!==v&&(l=Math.max(0,l-100)),l+=Math.min(5,Math.floor(p.width/100))}l>e&&(e=l,r=n,console.log("New best candidate (scoring) with score:",e,r))}}return r?console.log("Final selected best candidate (from scoring):",r):console.error("SCORING FAILED: No suitable media candidate found via scoring logic."),r};function D(t){if(t.dataset.geminiButtonAdded==="true")return;console.log("[addGenerateButton] Starting for textarea:",t);const a=t.parentElement;let c=(a==null?void 0:a.parentElement)||H(t);if(!c){console.error("[addGenerateButton] Could not find a suitable container for the button.");return}if(c.querySelector(`#${s}`)){console.log("[addGenerateButton] Button already exists in this container, skipping.");return}const i=c,r=document.createElement("div");Object.assign(r.style,{display:"flex",alignItems:"center",gap:"8px",marginLeft:"8px"});const e=document.createElement("button");e.id=s,e.title="Generate Alt Text",e.innerHTML='<svg width="20" height="20" viewBox="-5 -10 128 128" xmlns="http://www.w3.org/2000/svg"><path d="M 35.746,4 C 20.973,4 9,15.973 9,30.746 V 77.254 C 9,92.027 20.973,104 35.746,104 H 82.254 C 97.027,104 109,92.027 109,77.254 V 30.746 C 109,15.973 97.027,4 82.254,4 Z m -19.77,26.746 c 0,-10.918 8.8516,-19.77 19.77,-19.77 h 46.508 c 10.918,0 19.77,8.8516 19.77,19.77 v 46.508 c 0,10.918 -8.8516,19.77 -19.77,19.77 H 35.746 c -10.918,0 -19.77,-8.8516 -19.77,-19.77 z m 45.609,0.37891 c -1.082,-2.1055 -4.0898,-2.1055 -5.1719,0 l -4.3242,8.4219 c -1.668,3.2383 -4.3047,5.875 -7.543,7.543 l -8.4219,4.3242 c -2.1055,1.082 -2.1055,4.0898 0,5.1719 l 8.4219,4.3242 c 3.2383,1.668 5.875,4.3047 7.543,7.543 l 4.3242,8.4219 c 1.082,2.1055 4.0898,2.1055 5.1719,0 l 4.3242,-8.4219 c 1.668,-3.2383 4.3047,-5.875 7.543,-7.543 l 8.4219,-4.3242 c 2.1055,-1.082 2.1055,-4.0898 0,-5.1719 l -8.4219,-4.3242 c -3.2383,-1.668 -5.875,-4.3047 -7.543,-7.543 z" fill="#323248" stroke="none" /></svg>',Object.assign(e.style,{marginLeft:"8px",padding:"4px",cursor:"pointer",border:"1px solid #ccc",borderRadius:"4px",backgroundColor:"#f0f0f0",display:"flex",alignItems:"center",justifyContent:"center"}),e.style.setProperty("visibility","visible","important"),e.style.setProperty("z-index","9999","important"),e.style.setProperty("position","relative","important");const n=e.innerHTML,l=document.createElement("label");l.className="gemini-auto-toggle",l.title="Auto-generate alt text when media is added",Object.assign(l.style,{display:"flex",alignItems:"center",fontSize:"12px",cursor:"pointer"});const p=document.createElement("input");p.type="checkbox",p.style.margin="0 4px 0 0",p.checked=f.autoMode,p.addEventListener("change",async g=>{if(g.target instanceof HTMLInputElement){f.autoMode=g.target.checked;try{await m.storage.local.set({...f,autoMode:f.autoMode}),console.log("Saved autoMode setting:",f.autoMode)}catch(M){console.error("Error saving autoMode setting:",M)}}}),l.appendChild(p),l.appendChild(document.createTextNode("Auto")),r.appendChild(e),r.appendChild(l);const h=async()=>{e.innerHTML="",e.textContent="Connecting...",e.disabled=!0;const g=X(i);if(console.log("[generateAltText] Media element:",g),!g||!(g instanceof HTMLImageElement||g instanceof HTMLVideoElement)||!g.src){console.error("[generateAltText] Could not find valid media element or its src."),e.textContent="Error: No Media",setTimeout(()=>{e.innerHTML=n,e.disabled=!1},2e3);return}const M=g.src,L=g.tagName==="VIDEO";console.log(`[generateAltText] ${L?"Video":"Image"} URL:`,M);try{console.log("[generateAltText] Connecting to background...");const C=m.runtime.connect({name:"altTextGenerator"});console.log("[generateAltText] Connection established."),e.textContent="Generating...",C.onMessage.addListener(b=>{console.log("[generateAltText] Msg from background:",b);let v="",F=!1;if(b.altText)t.value=b.altText,t.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),v="✓ Done",f.showToasts&&_("Alt text generated! Please review.","success");else if(b.error){const B=typeof b.error=="string"?b.error:"Unknown error";v=`Error: ${B.substring(0,20)}...`,F=!0,f.showToasts&&_(`Error: ${B}`,"error")}else v="Msg Format Err",F=!0,console.error("[generateAltText] Unexpected message format:",b);e.textContent=v,setTimeout(()=>{e.innerHTML=n,e.disabled=!1},F?3e3:1500);try{C.disconnect()}catch{}}),C.onDisconnect.addListener(()=>{const b=m.runtime.lastError;console.error("[generateAltText] Port disconnected.",b||"(No error info)");const v=e.textContent;v&&!v.includes("Done")&&!v.includes("Error")&&(e.textContent="Disconnect Err",setTimeout(()=>{e.innerHTML=n,e.disabled=!1},3e3))}),console.log("[generateAltText] Sending message..."),C.postMessage({action:"generateAltText",imageUrl:M,isVideo:L}),console.log("[generateAltText] Message sent.")}catch(C){console.error("[generateAltText] Connect/Post error:",C),e.textContent="Connect Error",setTimeout(()=>{e.innerHTML=n,e.disabled=!1},2e3)}};e.onclick=async g=>{g.preventDefault(),g.stopPropagation(),console.log("[addGenerateButton] Button clicked"),await h()},a?a.appendChild(r):console.error("[addGenerateButton] Could not find textAreaContainer to append button to."),t.dataset.geminiButtonAdded="true",console.log("[addGenerateButton] Button setup complete.")}function H(t){var r;console.log("[findComposerContainer] Searching from:",t);const a=['[role="dialog"][aria-modal="true"]','[data-testid="composer"]'],c=['[data-testid="imagePreview"]','[data-testid="images"]','button[aria-label*="Post"]','button[type="submit"]'];for(const e of a){const n=t.closest(e);if(n&&n.contains(t)&&c.some(l=>n.querySelector(l)))return console.log("[findComposerContainer] Found valid container via selector:",e,n),n}console.log("[findComposerContainer] No primary container found, trying fallback parent check.");const i=((r=t.parentElement)==null?void 0:r.parentElement)||t.parentElement;return i?(console.warn("[findComposerContainer] Using fallback container:",i),i):(console.error("[findComposerContainer] Failed to find any container."),null)}const Y=()=>{new MutationObserver(a=>{if(f.autoMode)for(const c of a)c.type==="childList"&&c.addedNodes.forEach(i=>{if(i instanceof HTMLElement){const r=e=>{var n;if((e.tagName==="IMG"||e.tagName==="VIDEO")&&!((n=e.getAttribute("alt"))!=null&&n.includes("avatar"))){console.log("Auto-gen: Media element detected:",e);const l=H(e);l&&setTimeout(()=>{const p=l.querySelector(o);if(p){D(p);const h=l.querySelector(`#${s}`);h&&!h.disabled&&(console.log("Auto-generating alt text for:",e),h.click())}else console.log("Auto-gen: No alt text field found yet for media:",e)},500)}};r(i),i.querySelectorAll("img, video").forEach(r)}})}).observe(document.body,{childList:!0,subtree:!0}),console.log("Media observer started for auto-generation.")};document.querySelectorAll(o).forEach(D),new MutationObserver(t=>{console.log("Main observer triggered.");for(const a of t)a.type==="childList"&&a.addedNodes.forEach(c=>{c instanceof Element&&(c.matches(o)&&D(c),c.querySelectorAll(o).forEach(D))})}).observe(document.body,{childList:!0,subtree:!0}),Y();const $=t=>{console.log("[attachMediaListeners] Attaching to:",t);const a=t.querySelector(E),c=t.closest(T)||(t instanceof HTMLElement?t:null),i=a;i&&!i.dataset.mediaListenerAttached?(i.addEventListener("change",e=>{e.target instanceof HTMLInputElement&&(console.log("[attachMediaListeners] File input CHANGED"),q(e.target.files))}),i.dataset.mediaListenerAttached="true",console.log("[attachMediaListeners] Change listener attached to file input.")):i?console.log("[attachMediaListeners] Change listener already attached to file input."):console.warn("[attachMediaListeners] Could not find file input using selector:",E,"within:",t);const r=c;r&&!r.dataset.dropListenerAttached?(r.addEventListener("dragover",e=>{e.preventDefault(),e.stopPropagation()}),r.addEventListener("drop",e=>{var n;e.preventDefault(),e.stopPropagation(),console.log("[attachMediaListeners] DROP event detected"),(n=e.dataTransfer)!=null&&n.files&&q(e.dataTransfer.files)}),r.dataset.dropListenerAttached="true",console.log("[attachMediaListeners] Drop/Dragover listeners attached to drop zone:",r)):r?console.log("[attachMediaListeners] Drop/Dragover listeners already attached."):console.warn("[attachMediaListeners] Could not find drop zone using selector:",T)},G=()=>{console.log("Setting up observer for composer elements..."),new MutationObserver(a=>{for(const c of a)c.type==="childList"&&c.addedNodes.forEach(i=>{i instanceof Element&&(i.matches(u)&&(console.log("Composer added directly:",i),$(i)),i.querySelectorAll(u).forEach(r=>{console.log("Composer found via querySelectorAll:",r),$(r)}))})}).observe(document.body,{childList:!0,subtree:!0}),console.log("Composer observer started."),document.querySelectorAll(u).forEach($)};document.readyState==="complete"||document.readyState==="interactive"?G():document.addEventListener("DOMContentLoaded",G)}};function A(d,...o){}const W={debug:(...d)=>A(console.debug,...d),log:(...d)=>A(console.log,...d),warn:(...d)=>A(console.warn,...d),error:(...d)=>A(console.error,...d)},N=class N extends Event{constructor(o,s){super(N.EVENT_NAME,{}),this.newUrl=o,this.oldUrl=s}};w(N,"EVENT_NAME",P("wxt:locationchange"));let O=N;function P(d){var o;return`${(o=m==null?void 0:m.runtime)==null?void 0:o.id}:bsky_alt_generator:${d}`}function j(d){let o,s;return{run(){o==null&&(s=new URL(location.href),o=d.setInterval(()=>{let u=new URL(location.href);u.href!==s.href&&(window.dispatchEvent(new O(u,s)),s=u)},1e3))}}}const S=class S{constructor(o,s){w(this,"isTopFrame",window.self===window.top);w(this,"abortController");w(this,"locationWatcher",j(this));w(this,"receivedMessageIds",new Set);this.contentScriptName=o,this.options=s,this.abortController=new AbortController,this.isTopFrame?(this.listenForNewerScripts({ignoreFirstEvent:!0}),this.stopOldScripts()):this.listenForNewerScripts()}get signal(){return this.abortController.signal}abort(o){return this.abortController.abort(o)}get isInvalid(){return m.runtime.id==null&&this.notifyInvalidated(),this.signal.aborted}get isValid(){return!this.isInvalid}onInvalidated(o){return this.signal.addEventListener("abort",o),()=>this.signal.removeEventListener("abort",o)}block(){return new Promise(()=>{})}setInterval(o,s){const u=setInterval(()=>{this.isValid&&o()},s);return this.onInvalidated(()=>clearInterval(u)),u}setTimeout(o,s){const u=setTimeout(()=>{this.isValid&&o()},s);return this.onInvalidated(()=>clearTimeout(u)),u}requestAnimationFrame(o){const s=requestAnimationFrame((...u)=>{this.isValid&&o(...u)});return this.onInvalidated(()=>cancelAnimationFrame(s)),s}requestIdleCallback(o,s){const u=requestIdleCallback((...E)=>{this.signal.aborted||o(...E)},s);return this.onInvalidated(()=>cancelIdleCallback(u)),u}addEventListener(o,s,u,E){var T;s==="wxt:locationchange"&&this.isValid&&this.locationWatcher.run(),(T=o.addEventListener)==null||T.call(o,s.startsWith("wxt:")?P(s):s,u,{...E,signal:this.signal})}notifyInvalidated(){this.abort("Content script context invalidated"),W.debug(`Content script "${this.contentScriptName}" context invalidated`)}stopOldScripts(){window.postMessage({type:S.SCRIPT_STARTED_MESSAGE_TYPE,contentScriptName:this.contentScriptName,messageId:Math.random().toString(36).slice(2)},"*")}verifyScriptStartedEvent(o){var T,f,k;const s=((T=o.data)==null?void 0:T.type)===S.SCRIPT_STARTED_MESSAGE_TYPE,u=((f=o.data)==null?void 0:f.contentScriptName)===this.contentScriptName,E=!this.receivedMessageIds.has((k=o.data)==null?void 0:k.messageId);return s&&u&&E}listenForNewerScripts(o){let s=!0;const u=E=>{if(this.verifyScriptStartedEvent(E)){this.receivedMessageIds.add(E.data.messageId);const T=s;if(s=!1,T&&(o!=null&&o.ignoreFirstEvent))return;this.notifyInvalidated()}};addEventListener("message",u),this.onInvalidated(()=>removeEventListener("message",u))}};w(S,"SCRIPT_STARTED_MESSAGE_TYPE",P("wxt:content-script-started"));let R=S;function Q(){}function I(d,...o){}const Z={debug:(...d)=>I(console.debug,...d),log:(...d)=>I(console.log,...d),warn:(...d)=>I(console.warn,...d),error:(...d)=>I(console.error,...d)};return(async()=>{try{const{main:d,...o}=z,s=new R("bsky_alt_generator",o);return await d(s)}catch(d){throw Z.error('The content script "bsky_alt_generator" crashed on startup!',d),d}})()}();
bskyaltgenerator;
