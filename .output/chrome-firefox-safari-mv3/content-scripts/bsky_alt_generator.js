var bskyaltgenerator=function(){"use strict";var J=Object.defineProperty;var K=(x,y,m)=>y in x?J(x,y,{enumerable:!0,configurable:!0,writable:!0,value:m}):x[y]=m;var C=(x,y,m)=>K(x,typeof y!="symbol"?y+"":y,m);var B,_;function x(d){return d}const m=(_=(B=globalThis.browser)==null?void 0:B.runtime)!=null&&_.id?globalThis.browser:globalThis.chrome,H={matches:["*://*.bsky.app/*"],main(){if(console.log("Bluesky Alt Text Generator loaded"),typeof window>"u"||typeof document>"u")return;const a=['textarea[aria-label="Alt text"]','textarea[placeholder*="alt"]','textarea[placeholder*="Alt"]','textarea[data-testid*="alt"]','[role="textbox"][aria-label*="alt" i]'].join(","),l="gemini-alt-text-button",g='[data-testid="composer"]',h='input[type="file"][aria-label*="media" i]',E=g;let f={autoMode:!1,showToasts:!0};async function D(){try{const t=await m.storage.local.get(["autoMode","showToasts"]);t&&(f={...f,...t}),console.log("Loaded config:",f)}catch(t){console.error("Error loading config from storage:",t)}}D(),m.storage.onChanged.addListener((t,n)=>{if(n==="local"){let s=!1;t.autoMode&&(f.autoMode=t.autoMode.newValue,s=!0),t.showToasts&&(f.showToasts=t.showToasts.newValue,s=!0),s&&console.log("Updated config via storage listener:",f)}});const V=t=>{if(!(!t||t.length===0)){console.log(`Intercepted ${t.length} file(s)`);for(const n of t){if(!n.type.startsWith("image/")&&!n.type.startsWith("video/")){console.log(`Skipping non-media file: ${n.name} (${n.type})`);continue}const s=new FileReader;s.onload=r=>{var i;const e=(i=r.target)==null?void 0:i.result;typeof e=="string"?(console.log(`Read file ${n.name} (${n.type}), sending to background...`),m.runtime.sendMessage({type:"MEDIA_INTERCEPTED",payload:{filename:n.name,filetype:n.type,dataUrl:e,size:n.size}}).then(o=>{console.log("Background script responded to MEDIA_INTERCEPTED:",o)}).catch(o=>{console.error("Error sending MEDIA_INTERCEPTED message or receiving response:",o)}),f.showToasts&&F(`Captured ${n.name}`,"info",2e3)):console.error(`Failed to read file ${n.name} as Base64 Data URL.`)},s.onerror=r=>{console.error(`Error reading file ${n.name}:`,r)},s.readAsDataURL(n)}}},F=(t,n="info",s=5e3)=>{let r=document.getElementById("gemini-toast-container");r||(r=document.createElement("div"),r.id="gemini-toast-container",Object.assign(r.style,{position:"fixed",bottom:"20px",right:"20px",zIndex:"10000",display:"flex",flexDirection:"column",gap:"10px"}),document.body.appendChild(r));const e=document.createElement("div");Object.assign(e.style,{padding:"12px 16px",borderRadius:"6px",boxShadow:"0 2px 8px rgba(0, 0, 0, 0.15)",margin:"5px",minWidth:"200px",color:"#ffffff",fontSize:"14px",transition:"all 0.3s ease"});const i={success:"#1da882",error:"#e53935",warning:"#f59f0b",info:"#007eda"};e.style.backgroundColor=i[n]||i.info,e.textContent=t;const o=document.createElement("span");o.textContent="Ã—",Object.assign(o.style,{marginLeft:"8px",cursor:"pointer",float:"right",fontWeight:"bold"}),o.onclick=()=>{e.parentNode===r&&r.removeChild(e)},e.appendChild(o),r.appendChild(e),setTimeout(()=>{e.parentNode===r&&r.removeChild(e)},s)},Z=t=>{console.log("Searching for media in container:",t);const n=o=>{if(!o)return!1;const c=o.getBoundingClientRect();return c.width>10&&c.height>10&&o.offsetParent!==null},s=['[data-testid="imagePreview"] img[src^="data:image/"]','[data-testid="images"] img[src^="data:image/"]','[data-testid="imagePreview"] img[src^="blob:"]','[data-testid="images"] img[src^="blob:"]','img[src^="data:image/"]','img[src^="blob:"]'];for(const o of s){const c=t.querySelector(o);if(n(c))return console.log(`Found image via selector: ${o}`,c),c;c&&console.warn(`Image found but hidden/too small with selector: ${o}`,c)}console.log("No valid data/blob URL image found via direct selectors, proceeding to scoring logic...");const r=Array.from(t.querySelectorAll("img, video"));let e=null,i=-1;for(const o of r){let c=0;const v=o.getBoundingClientRect();if(n(o)){if(o instanceof HTMLVideoElement)if(o.src||o.querySelector("source[src]"))c=1e3;else continue;else if(o instanceof HTMLImageElement){const u=o,p=u.src||"",U=u.alt||"";if(!p||p.startsWith("data:")||p.startsWith("blob:")||U.toLowerCase().includes("avatar")||p.includes("avatar")||p.includes("profile"))continue;const w=50;if(v.width<w||v.height<w)continue;c=1,console.log(`Valid scoring candidate: ${v.width}x${v.height}`,u),u.closest('[data-testid="imagePreview"], .r-1p0dtai[style*="aspect-ratio"]')&&(c+=500),c<=1&&u.matches('[data-testid*="image"], [data-testid*="preview"], [role="img"]')&&(c+=50);const b=u.closest('[data-testid="postView"], [role="article"]'),M=t instanceof Element?t.closest('[data-testid="postView"], [role="article"]'):null;b&&M&&b!==M&&(c=Math.max(0,c-100)),c+=Math.min(5,Math.floor(v.width/100))}c>i&&(i=c,e=o,console.log("New best candidate (scoring) with score:",i,e))}}return e?console.log("Final selected best candidate (from scoring):",e):console.error("SCORING FAILED: No suitable media candidate found via scoring logic."),e};async function X(t){if(!t||!t.src)return console.warn("[getMediaAsDataUrl] Invalid element or src"),null;const n=t.src;if(n.startsWith("data:"))return console.log("[getMediaAsDataUrl] Source is already Data URL"),n;if(n.startsWith("blob:")||n.startsWith("http")){console.log("[getMediaAsDataUrl] Fetching source URL:",n);try{const s=await fetch(n);if(!s.ok)throw new Error(`Failed to fetch media URL: ${s.statusText} (${s.status})`);const r=await s.blob();return console.log("[getMediaAsDataUrl] Fetched blob, type:",r.type),new Promise((e,i)=>{const o=new FileReader;o.onloadend=()=>{typeof o.result=="string"?(console.log("[getMediaAsDataUrl] Blob converted to base64 Data URL"),e(o.result)):i(new Error("Blob reader result was not a string."))},o.onerror=c=>{console.error("[getMediaAsDataUrl] FileReader error:",c),i(new Error("FileReader error reading blob."))},o.readAsDataURL(r)})}catch(s){return console.error("[getMediaAsDataUrl] Error fetching or converting URL:",s),null}}else return console.warn("[getMediaAsDataUrl] Unhandled URL scheme:",n),null}function R(t){if(t.dataset.geminiButtonAdded==="true")return;console.log("[addGenerateButton] Starting for textarea:",t);const n=q(t);if(!n){console.error("[addGenerateButton] Could not find the main composer container using findComposerContainer. Button will not be added or may not function correctly.");return}if(console.log("[addGenerateButton] Found composer container:",n),n.querySelector(`#${l}`)){console.log("[addGenerateButton] Button already exists in this composer container, marking textarea and skipping UI creation."),t.dataset.geminiButtonAdded="true";return}const s=t.parentElement;if(!s){console.error("[addGenerateButton] Could not find a suitable attach point (parentElement) for the button UI near the textarea.");return}const r=document.createElement("div");Object.assign(r.style,{display:"flex",alignItems:"center",gap:"8px",marginTop:"4px",justifyContent:"flex-end"});const e=document.createElement("button");e.id=l,e.title="Generate Alt Text",e.innerHTML='<svg width="20" height="20" viewBox="-5 -10 128 128" xmlns="http://www.w3.org/2000/svg"><path d="M 35.746,4 C 20.973,4 9,15.973 9,30.746 V 77.254 C 9,92.027 20.973,104 35.746,104 H 82.254 C 97.027,104 109,92.027 109,77.254 V 30.746 C 109,15.973 97.027,4 82.254,4 Z m -19.77,26.746 c 0,-10.918 8.8516,-19.77 19.77,-19.77 h 46.508 c 10.918,0 19.77,8.8516 19.77,19.77 v 46.508 c 0,10.918 -8.8516,19.77 -19.77,19.77 H 35.746 c -10.918,0 -19.77,-8.8516 -19.77,-19.77 z m 45.609,0.37891 c -1.082,-2.1055 -4.0898,-2.1055 -5.1719,0 l -4.3242,8.4219 c -1.668,3.2383 -4.3047,5.875 -7.543,7.543 l -8.4219,4.3242 c -2.1055,1.082 -2.1055,4.0898 0,5.1719 l 8.4219,4.3242 c 3.2383,1.668 5.875,4.3047 7.543,7.543 l 4.3242,8.4219 c 1.082,2.1055 4.0898,2.1055 5.1719,0 l 4.3242,-8.4219 c 1.668,-3.2383 4.3047,-5.875 7.543,-7.543 l 8.4219,-4.3242 c 2.1055,-1.082 2.1055,-4.0898 0,-5.1719 l -8.4219,-4.3242 c -3.2383,-1.668 -5.875,-4.3047 -7.543,-7.543 z" fill="#323248" stroke="none" /></svg>',Object.assign(e.style,{marginLeft:"8px",padding:"4px",cursor:"pointer",border:"1px solid #ccc",borderRadius:"4px",backgroundColor:"#f0f0f0",display:"flex",alignItems:"center",justifyContent:"center"}),e.style.setProperty("visibility","visible","important"),e.style.setProperty("z-index","9999","important"),e.style.setProperty("position","relative","important");const i=e.innerHTML,o=document.createElement("label");o.className="gemini-auto-toggle",o.title="Auto-generate alt text when media is added",Object.assign(o.style,{display:"flex",alignItems:"center",fontSize:"12px",cursor:"pointer"});const c=document.createElement("input");c.type="checkbox",c.style.margin="0 4px 0 0",c.checked=f.autoMode,c.addEventListener("change",async u=>{if(u.target instanceof HTMLInputElement){f.autoMode=u.target.checked;try{await m.storage.local.set({...f,autoMode:f.autoMode}),console.log("Saved autoMode setting:",f.autoMode)}catch(p){console.error("Error saving autoMode setting:",p)}}}),o.appendChild(c),o.appendChild(document.createTextNode("Auto")),r.appendChild(e),r.appendChild(o);const v=async()=>{e.innerHTML="",e.textContent="Finding Media...",e.disabled=!0,console.log("[generateAltText] Searching for media within confirmed composer container:",n);const u=Z(n);if(console.log("[generateAltText] Media element found in composer:",u),!u||!(u instanceof HTMLImageElement||u instanceof HTMLVideoElement)){console.error("[generateAltText] Could not find valid media element."),e.textContent="Error: No Media",setTimeout(()=>{e.innerHTML=i,e.disabled=!1},2e3);return}e.textContent="Processing Media...";const p=await X(u);if(!p){console.error("[generateAltText] Failed to get media as Data URL."),e.textContent="Error: Process Fail",setTimeout(()=>{e.innerHTML=i,e.disabled=!1},3e3);return}const U=u.tagName==="VIDEO";console.log(`[generateAltText] Got ${U?"Video":"Image"} as Data URL (length: ${p.length})`);try{console.log("[generateAltText] Connecting to background..."),e.textContent="Connecting...";const w=m.runtime.connect({name:"altTextGenerator"});console.log("[generateAltText] Connection established."),e.textContent="Generating...",w.onMessage.addListener(T=>{console.log("[generateAltText] Msg from background:",T);let b="",M=!1;if(T.altText)t.value=T.altText,t.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),b="âœ“ Done",f.showToasts&&F("Alt text generated! Please review.","success");else if(T.error){const $=typeof T.error=="string"?T.error:"Unknown error";b=`Error: ${$.substring(0,20)}...`,M=!0,f.showToasts&&F(`Error: ${$}`,"error")}else b="Msg Format Err",M=!0,console.error("[generateAltText] Unexpected message format:",T);e.textContent=b,setTimeout(()=>{e.innerHTML=i,e.disabled=!1},M?3e3:1500);try{w.disconnect()}catch{}}),w.onDisconnect.addListener(()=>{const T=m.runtime.lastError;console.error("[generateAltText] Port disconnected.",T||"(No error info)");const b=e.textContent;b&&!b.includes("Done")&&!b.includes("Error")&&(e.textContent="Disconnect Err",setTimeout(()=>{e.innerHTML=i,e.disabled=!1},3e3))}),console.log("[generateAltText] Sending message..."),w.postMessage({action:"generateAltText",imageUrl:p,isVideo:U}),console.log("[generateAltText] Message sent.")}catch(w){console.error("[generateAltText] Connect/Post error:",w),e.textContent="Connect Error",setTimeout(()=>{e.innerHTML=i,e.disabled=!1},2e3)}};e.onclick=async u=>{u.preventDefault(),u.stopPropagation(),console.log("[addGenerateButton] Button clicked"),await v()},s.insertAdjacentElement("afterend",r),t.dataset.geminiButtonAdded="true",console.log("[addGenerateButton] Button UI setup complete and attached.")}function q(t){var e;console.log("[findComposerContainer] Searching from:",t);const n=['[role="dialog"][aria-modal="true"]','[data-testid="composer"]'],s=['[data-testid="imagePreview"]','[data-testid="images"]','button[aria-label*="Post"]','button[type="submit"]'];for(const i of n){const o=t.closest(i);if(o&&o.contains(t)&&s.some(c=>o.querySelector(c)))return console.log("[findComposerContainer] Found valid container via selector:",i,o),o}console.log("[findComposerContainer] No primary container found, trying fallback parent check.");const r=((e=t.parentElement)==null?void 0:e.parentElement)||t.parentElement;return r?(console.warn("[findComposerContainer] Using fallback container:",r),r):(console.error("[findComposerContainer] Failed to find any container."),null)}const Y=()=>{new MutationObserver(n=>{if(f.autoMode)for(const s of n)s.type==="childList"&&s.addedNodes.forEach(r=>{if(r instanceof HTMLElement){const e=i=>{var o;if((i.tagName==="IMG"||i.tagName==="VIDEO")&&!((o=i.getAttribute("alt"))!=null&&o.includes("avatar"))){console.log("Auto-gen: Media element detected:",i);const c=q(i);c&&setTimeout(()=>{const v=c.querySelector(a);if(v){R(v);const u=c.querySelector(`#${l}`);u&&!u.disabled&&(console.log("Auto-generating alt text for:",i),u.click())}else console.log("Auto-gen: No alt text field found yet for media:",i)},500)}};e(r),r.querySelectorAll("img, video").forEach(e)}})}).observe(document.body,{childList:!0,subtree:!0}),console.log("Media observer started for auto-generation.")};document.querySelectorAll(a).forEach(R),new MutationObserver(t=>{console.log("Main observer triggered.");for(const n of t)n.type==="childList"&&n.addedNodes.forEach(s=>{s instanceof Element&&(s.matches(a)&&R(s),s.querySelectorAll(a).forEach(R))})}).observe(document.body,{childList:!0,subtree:!0}),Y();const O=t=>{console.log("[attachMediaListeners] Attaching to:",t);const n=t.querySelector(h),s=t.closest(E)||(t instanceof HTMLElement?t:null),r=n;r&&!r.dataset.mediaListenerAttached?(r.addEventListener("change",i=>{i.target instanceof HTMLInputElement&&(console.log("[attachMediaListeners] File input CHANGED"),V(i.target.files))}),r.dataset.mediaListenerAttached="true",console.log("[attachMediaListeners] Change listener attached to file input.")):r?console.log("[attachMediaListeners] Change listener already attached to file input."):console.warn("[attachMediaListeners] Could not find file input using selector:",h,"within:",t);const e=s;e&&!e.dataset.dropListenerAttached?(e.addEventListener("dragover",i=>{i.preventDefault(),i.stopPropagation()}),e.addEventListener("drop",i=>{var o;i.preventDefault(),i.stopPropagation(),console.log("[attachMediaListeners] DROP event detected"),(o=i.dataTransfer)!=null&&o.files&&V(i.dataTransfer.files)}),e.dataset.dropListenerAttached="true",console.log("[attachMediaListeners] Drop/Dragover listeners attached to drop zone:",e)):e?console.log("[attachMediaListeners] Drop/Dragover listeners already attached."):console.warn("[attachMediaListeners] Could not find drop zone using selector:",E)},G=()=>{console.log("Setting up observer for composer elements..."),new MutationObserver(n=>{for(const s of n)s.type==="childList"&&s.addedNodes.forEach(r=>{r instanceof Element&&(r.matches(g)&&(console.log("Composer added directly:",r),O(r)),r.querySelectorAll(g).forEach(e=>{console.log("Composer found via querySelectorAll:",e),O(e)}))})}).observe(document.body,{childList:!0,subtree:!0}),console.log("Composer observer started."),document.querySelectorAll(g).forEach(O)};document.readyState==="complete"||document.readyState==="interactive"?G():document.addEventListener("DOMContentLoaded",G)}};function A(d,...a){}const W={debug:(...d)=>A(console.debug,...d),log:(...d)=>A(console.log,...d),warn:(...d)=>A(console.warn,...d),error:(...d)=>A(console.error,...d)},I=class I extends Event{constructor(a,l){super(I.EVENT_NAME,{}),this.newUrl=a,this.oldUrl=l}};C(I,"EVENT_NAME",P("wxt:locationchange"));let N=I;function P(d){var a;return`${(a=m==null?void 0:m.runtime)==null?void 0:a.id}:bsky_alt_generator:${d}`}function z(d){let a,l;return{run(){a==null&&(l=new URL(location.href),a=d.setInterval(()=>{let g=new URL(location.href);g.href!==l.href&&(window.dispatchEvent(new N(g,l)),l=g)},1e3))}}}const L=class L{constructor(a,l){C(this,"isTopFrame",window.self===window.top);C(this,"abortController");C(this,"locationWatcher",z(this));C(this,"receivedMessageIds",new Set);this.contentScriptName=a,this.options=l,this.abortController=new AbortController,this.isTopFrame?(this.listenForNewerScripts({ignoreFirstEvent:!0}),this.stopOldScripts()):this.listenForNewerScripts()}get signal(){return this.abortController.signal}abort(a){return this.abortController.abort(a)}get isInvalid(){return m.runtime.id==null&&this.notifyInvalidated(),this.signal.aborted}get isValid(){return!this.isInvalid}onInvalidated(a){return this.signal.addEventListener("abort",a),()=>this.signal.removeEventListener("abort",a)}block(){return new Promise(()=>{})}setInterval(a,l){const g=setInterval(()=>{this.isValid&&a()},l);return this.onInvalidated(()=>clearInterval(g)),g}setTimeout(a,l){const g=setTimeout(()=>{this.isValid&&a()},l);return this.onInvalidated(()=>clearTimeout(g)),g}requestAnimationFrame(a){const l=requestAnimationFrame((...g)=>{this.isValid&&a(...g)});return this.onInvalidated(()=>cancelAnimationFrame(l)),l}requestIdleCallback(a,l){const g=requestIdleCallback((...h)=>{this.signal.aborted||a(...h)},l);return this.onInvalidated(()=>cancelIdleCallback(g)),g}addEventListener(a,l,g,h){var E;l==="wxt:locationchange"&&this.isValid&&this.locationWatcher.run(),(E=a.addEventListener)==null||E.call(a,l.startsWith("wxt:")?P(l):l,g,{...h,signal:this.signal})}notifyInvalidated(){this.abort("Content script context invalidated"),W.debug(`Content script "${this.contentScriptName}" context invalidated`)}stopOldScripts(){window.postMessage({type:L.SCRIPT_STARTED_MESSAGE_TYPE,contentScriptName:this.contentScriptName,messageId:Math.random().toString(36).slice(2)},"*")}verifyScriptStartedEvent(a){var E,f,D;const l=((E=a.data)==null?void 0:E.type)===L.SCRIPT_STARTED_MESSAGE_TYPE,g=((f=a.data)==null?void 0:f.contentScriptName)===this.contentScriptName,h=!this.receivedMessageIds.has((D=a.data)==null?void 0:D.messageId);return l&&g&&h}listenForNewerScripts(a){let l=!0;const g=h=>{if(this.verifyScriptStartedEvent(h)){this.receivedMessageIds.add(h.data.messageId);const E=l;if(l=!1,E&&(a!=null&&a.ignoreFirstEvent))return;this.notifyInvalidated()}};addEventListener("message",g),this.onInvalidated(()=>removeEventListener("message",g))}};C(L,"SCRIPT_STARTED_MESSAGE_TYPE",P("wxt:content-script-started"));let k=L;function Q(){}function S(d,...a){}const j={debug:(...d)=>S(console.debug,...d),log:(...d)=>S(console.log,...d),warn:(...d)=>S(console.warn,...d),error:(...d)=>S(console.error,...d)};return(async()=>{try{const{main:d,...a}=H,l=new k("bsky_alt_generator",a);return await d(l)}catch(d){throw j.error('The content script "bsky_alt_generator" crashed on startup!',d),d}})()}();
bskyaltgenerator;
