var bskyaltgenerator=function(){"use strict";var G=Object.defineProperty;var H=(x,v,T)=>v in x?G(x,v,{enumerable:!0,configurable:!0,writable:!0,value:T}):x[v]=T;var E=(x,v,T)=>H(x,typeof v!="symbol"?v+"":v,T);var D,F;function x(c){return c}const v={matches:["*://*.bsky.app/*"],main(){if(console.log("Bluesky Alt Text Generator loaded"),typeof window>"u"||typeof document>"u")return;const o=['textarea[aria-label="Alt text"]','textarea[placeholder*="alt"]','textarea[placeholder*="Alt"]','textarea[data-testid*="alt"]','[role="textbox"][aria-label*="alt" i]'].join(","),a="gemini-alt-text-button";let s={autoMode:!1,showToasts:!0};const h={storage:{sync:{get:(t,n)=>{var r;try{(r=chrome==null?void 0:chrome.storage)!=null&&r.sync?chrome.storage.sync.get(t,n):(console.warn("Chrome storage API not available, using default values"),n({}))}catch(e){console.error("Error accessing chrome.storage.sync.get:",e),n({})}},set:t=>{var n;try{(n=chrome==null?void 0:chrome.storage)!=null&&n.sync?chrome.storage.sync.set(t):console.warn("Chrome storage API not available, cannot save settings")}catch(r){console.error("Error accessing chrome.storage.sync.set:",r)}}}},runtime:{connect:t=>{var n;try{if((n=chrome==null?void 0:chrome.runtime)!=null&&n.connect)return chrome.runtime.connect(t);throw console.error("Chrome runtime API not available"),new Error("Chrome runtime API not available")}catch(r){throw console.error("Error connecting to background script:",r),r}},onChanged:{addListener:t=>{var n;try{(n=chrome==null?void 0:chrome.storage)!=null&&n.onChanged?chrome.storage.onChanged.addListener(t):console.warn("Chrome storage.onChanged API not available")}catch(r){console.error("Error adding onChanged listener:",r)}}}}};h.storage.sync.get(["autoMode","showToasts"],t=>{t.autoMode!==void 0&&(s.autoMode=t.autoMode),t.showToasts!==void 0&&(s.showToasts=t.showToasts),console.log("Loaded config:",s)}),h.runtime.onChanged.addListener(t=>{t.autoMode&&(s.autoMode=t.autoMode.newValue),t.showToasts&&(s.showToasts=t.showToasts.newValue),console.log("Updated config:",s)});const y=(t,n="info",r=5e3)=>{let e=document.getElementById("gemini-toast-container");e||(e=document.createElement("div"),e.id="gemini-toast-container",e.style.position="fixed",e.style.bottom="20px",e.style.right="20px",e.style.zIndex="10000",e.style.display="flex",e.style.flexDirection="column",e.style.gap="10px",document.body.appendChild(e));const i=document.createElement("div");i.style.padding="12px 16px",i.style.borderRadius="6px",i.style.boxShadow="0 2px 8px rgba(0, 0, 0, 0.15)",i.style.margin="5px",i.style.minWidth="200px",i.style.color="#ffffff",i.style.fontSize="14px",i.style.transition="all 0.3s ease",n==="success"?i.style.backgroundColor="#1da882":n==="error"?i.style.backgroundColor="#e53935":n==="warning"?i.style.backgroundColor="#f59f0b":i.style.backgroundColor="#007eda",i.textContent=t;const l=document.createElement("span");l.textContent="×",l.style.marginLeft="8px",l.style.cursor="pointer",l.style.float="right",l.style.fontWeight="bold",l.onclick=()=>{e.removeChild(i)},i.appendChild(l),e.appendChild(i),setTimeout(()=>{e.contains(i)&&e.removeChild(i)},r)},N=t=>{var m;console.log("Searching for media in container:",t);const n=t.querySelector('[data-testid="imagePreview"] img[src^="data:image/"], [data-testid="images"] img[src^="data:image/"]');if(n){console.log("Found image via SPECIFIC data URL selector:",n);const d=n.getBoundingClientRect();if(d.width>10&&d.height>10&&n.offsetParent!==null)return console.log("Specific data URL image is valid, returning it."),n;console.warn("Specific data URL image found but seems hidden/too small. Rect:",d,"OffsetParent:",n.offsetParent)}else console.log('Did not find image via SPECIFIC data URL selector (e.g., [data-testid="imagePreview"] img[src^="data:image/"]).');const r=t.querySelector('img[src^="data:image/"]');if(r){console.log("Found image via ANY data URL selector:",r);const d=r.getBoundingClientRect();if(d.width>10&&d.height>10&&r.offsetParent!==null)return console.log("ANY data URL image is valid, returning it."),r;console.warn("ANY data URL image found but seems hidden/too small. Rect:",d,"OffsetParent:",r.offsetParent)}else console.log("Did not find image via ANY data URL selector.");console.log("No valid data URL image found, proceeding to scoring logic...");const e=Array.from(t.querySelectorAll("img, video"));console.log(`Found ${e.length} candidates for scoring.`);let i=null,l=-1;for(const d of e){let g=0;const u=d.getBoundingClientRect();if(!(u.width===0||u.height===0||d.offsetParent===null)){if(d.tagName==="VIDEO")if((m=d.src)!=null&&m.startsWith("data:video/")||d.src||d.querySelector("source[src]"))console.log("Found video candidate:",d),g=1e3;else continue;else{const f=d,C=f.src||"",p=f.alt||"";if(!C||C.startsWith("data:")||p.toLowerCase().includes("avatar")||C.includes("avatar")||C.includes("profile"))continue;const b=50;if(u.width<b||u.height<b)continue;g=1,console.log(`Valid image candidate found: ${u.width}x${u.height}`,f),f.closest('[data-testid="imagePreview"], .r-1p0dtai[style*="aspect-ratio"]')&&(console.log("Image is inside a high-priority preview wrapper, boosting score significantly."),g+=500),g<=1&&f.matches('[data-testid*="image"], [data-testid*="preview"], [role="img"]')&&(console.log("Image has a relevant test ID/role, boosting score."),g+=50);const q=f.closest('[data-testid="postView"], [role="article"]'),O=t.closest('[data-testid="postView"], [role="article"]');q&&O&&q!==O&&(console.log("Image seems to be inside a *different* post structure, penalizing score."),g=Math.max(0,g-100)),g+=Math.min(5,Math.floor(u.width/100))}console.log("Candidate score:",g,d),g>l&&(l=g,i=d,console.log("New best candidate selected with score:",l,i))}}return i?console.log("Final selected best candidate (from scoring):",i):(console.error("Failed to find a suitable media candidate within the container after scoring (Highest score <= 0)."),console.error("SCORING FAILED: No suitable media candidate found via scoring logic.")),i};function w(t){if(console.log("addGenerateButton called for textarea:",t),t.dataset.geminiButtonAdded==="true"){console.log("Button already added to this textarea, skipping.");return}let n=V(t);if(!n){console.error("Could not find a suitable container for the button near textarea:",t);return}if(console.log("Found container:",n),n.querySelector(`#${a}`)){console.log("Button already exists in this container, skipping.");return}const r=document.createElement("div");r.style.display="flex",r.style.alignItems="center",r.style.gap="8px",r.style.marginLeft="8px";const e=document.createElement("button");e.id=a,e.title="Generate Alt Text",e.innerHTML=`
        <svg width="20" height="20" viewBox="-5 -10 128 128" xmlns="http://www.w3.org/2000/svg">
          <path d="M 35.746,4 C 20.973,4 9,15.973 9,30.746 V 77.254 C 9,92.027 20.973,104 35.746,104 H 82.254 C 97.027,104 109,92.027 109,77.254 V 30.746 C 109,15.973 97.027,4 82.254,4 Z m -19.77,26.746 c 0,-10.918 8.8516,-19.77 19.77,-19.77 h 46.508 c 10.918,0 19.77,8.8516 19.77,19.77 v 46.508 c 0,10.918 -8.8516,19.77 -19.77,19.77 H 35.746 c -10.918,0 -19.77,-8.8516 -19.77,-19.77 z m 45.609,0.37891 c -1.082,-2.1055 -4.0898,-2.1055 -5.1719,0 l -4.3242,8.4219 c -1.668,3.2383 -4.3047,5.875 -7.543,7.543 l -8.4219,4.3242 c -2.1055,1.082 -2.1055,4.0898 0,5.1719 l 8.4219,4.3242 c 3.2383,1.668 5.875,4.3047 7.543,7.543 l 4.3242,8.4219 c 1.082,2.1055 4.0898,2.1055 5.1719,0 l 4.3242,-8.4219 c 1.668,-3.2383 4.3047,-5.875 7.543,-7.543 l 8.4219,-4.3242 c 2.1055,-1.082 2.1055,-4.0898 0,-5.1719 l -8.4219,-4.3242 c -3.2383,-1.668 -5.875,-4.3047 -7.543,-7.543 z" 
             fill="#323248" stroke="none" />
        </svg>
      `,e.style.marginLeft="8px",e.style.padding="4px",e.style.cursor="pointer",e.style.border="1px solid #ccc",e.style.borderRadius="4px",e.style.backgroundColor="#f0f0f0",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.setProperty("visibility","visible","important"),e.style.setProperty("z-index","9999","important"),e.style.setProperty("position","relative","important"),console.log("Button element created:",e);const i=e.innerHTML,l=document.createElement("label");l.className="gemini-auto-toggle",l.title="Auto-generate alt text when media is added",l.style.display="flex",l.style.alignItems="center",l.style.fontSize="12px",l.style.cursor="pointer";const m=document.createElement("input");m.type="checkbox",m.style.margin="0 4px 0 0",m.checked=s.autoMode,m.addEventListener("change",u=>{s.autoMode=u.target.checked,h.storage.sync.set({autoMode:s.autoMode})}),l.appendChild(m),l.appendChild(document.createTextNode("Auto")),r.appendChild(e),r.appendChild(l);const d=async()=>{e.innerHTML="",e.textContent="Connecting...",e.disabled=!0;const u=N(n);if(console.log("Media element found:",u),!u||!u.src){console.error("Could not find media element or its src."),e.textContent="Error: No Media",setTimeout(()=>{e.textContent="",e.innerHTML=i,e.disabled=!1},2e3);return}const f=u.src,C=u.tagName.toLowerCase()==="video";console.log(`${C?"Video":"Image"} URL:`,f);try{console.log("Establishing connection to background script...");const p=h.runtime.connect({name:"altTextGenerator"});console.log("Connection established."),e.textContent="Generating...",p.onMessage.addListener(b=>{console.log("Message received from background via port:",b),b.altText?(t.value=b.altText,t.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),console.log("Alt text inserted."),e.textContent="✓ Done",s.showToasts&&y("Alt text generated! Please review for accuracy before posting.","success"),setTimeout(()=>{e.textContent="",e.innerHTML=i,e.disabled=!1},1500)):b.error?(console.error("Error generating alt text:",b.error),e.textContent=`Error: ${b.error.substring(0,20)}...`,s.showToasts&&y(`Error: ${b.error}`,"error"),setTimeout(()=>{e.textContent="",e.innerHTML=i,e.disabled=!1},3e3)):(console.error("Received unexpected message format from background:",b),e.textContent="Msg Format Error",setTimeout(()=>{e.textContent="",e.innerHTML=i,e.disabled=!1},2e3)),p.disconnect()}),p.onDisconnect.addListener(()=>{console.error("Background port disconnected unexpectedly.",chrome.runtime.lastError||"(No error info)"),!e.textContent.includes("Done")&&!e.textContent.includes("Error")&&(e.textContent="Disconnect Error",setTimeout(()=>{e.textContent="",e.innerHTML=i,e.disabled=!1},3e3))}),console.log("Sending message via port..."),p.postMessage({action:"generateAltText",imageUrl:f,isVideo:C}),console.log("Message sent via port.")}catch(p){console.error("Error establishing connection or posting initial message:",p),e.textContent="Connect Error",setTimeout(()=>{e.textContent="",e.innerHTML=i,e.disabled=!1},2e3)}};e.onclick=async u=>{u.preventDefault(),u.stopPropagation(),console.log("Generate Alt Text button clicked"),await d()};const g=t.parentNode;g?(console.log("Attempting to append button container to parent:",g),g.appendChild(r)):console.error("Could not find parent node to append button to."),t.dataset.geminiButtonAdded="true",console.log("Button insertion attempted. Check the DOM.")}function V(t){var u;console.log("[findComposerContainer] Starting search for element:",t);const n=t.closest('[role="dialog"][aria-modal="true"]');if(n){if(console.log("[findComposerContainer] Found potential modal dialog:",n),n.contains(t)&&(n.querySelector('[data-testid="imagePreview"], [data-testid="images"]')||n.querySelector('button[aria-label*="Post"], button[type="submit"]')))return console.log("[findComposerContainer] Returning: Priority 1 - Valid Modal Dialog"),n;console.warn("[findComposerContainer] Modal dialog found, but validation failed. Continuing search...")}else console.log("[findComposerContainer] Priority 1: No modal dialog found.");const r=t.closest('[data-testid="composer"]');if(r){if(console.log('[findComposerContainer] Found potential data-testid="composer":',r),r.contains(t)&&(r.querySelector('[data-testid="imagePreview"], [data-testid="images"]')||r.querySelector('button[aria-label*="Post"], button[type="submit"]')))return console.log("[findComposerContainer] Returning: Priority 2 - Valid Test ID Composer"),r;console.warn("[findComposerContainer] Test ID composer found, but validation failed. Continuing search...")}else console.log('[findComposerContainer] Priority 2: No data-testid="composer" found.');console.log("[findComposerContainer] Entering Priority 3: Strict Lowest Common Ancestor search...");let e=t.parentElement,i=10,l=null;const m='[data-testid="imagePreview"] img:not([alt*="avatar"]), [data-testid="images"] img:not([alt*="avatar"])',d='button[aria-label*="Post"], button[type="submit"], button[aria-label*="Cancel"], button[aria-label*="Close"]';for(;e&&e.tagName!=="BODY"&&i>0;){if(e.contains(t)&&e.querySelector(m)&&e.querySelector(d)){console.log("[findComposerContainer] Found potential common ancestor:",e),l=e;const f=e.parentElement;if(!f||f.tagName==="BODY"||!f.contains(t)||!f.querySelector(m)||!f.querySelector(d)){console.log("[findComposerContainer] Parent validation failed, selecting current as lowest common ancestor:",l);break}}i--,e=e.parentElement}if(l)return console.log("[findComposerContainer] Returning: Priority 3 - Lowest Common Ancestor"),l;console.log("[findComposerContainer] Priority 3: No suitable common ancestor found.");const g=n||r||((u=t.parentElement)==null?void 0:u.parentElement)||t.parentElement;return console.error("[findComposerContainer] Returning: Last Resort Fallback:",g),g}const $=()=>{new MutationObserver(n=>{for(const r of n)r.type==="childList"&&r.addedNodes.forEach(e=>{var i;if(e.nodeType===Node.ELEMENT_NODE){const l=e;if((l.tagName==="IMG"||l.tagName==="VIDEO")&&!((i=l.getAttribute("alt"))!=null&&i.includes("avatar"))&&(console.log("Media element detected:",l),s.autoMode)){const m=l.closest('[data-testid="composer"], [role="dialog"], .css-175oi2r');m&&setTimeout(()=>{const d=m.querySelector(o);if(d){w(d);const g=m.querySelector(`#${a}`);g&&!g.disabled&&(console.log("Auto-generating alt text for newly added media"),g.click())}else{console.log("No alt text field found for auto-generation");const g=new MutationObserver(u=>{for(const f of u)if(f.type==="childList"){const C=m.querySelector(o);if(C){w(C);const p=m.querySelector(`#${a}`);p&&!p.disabled&&(console.log("Alt text field found after waiting, auto-generating"),p.click(),g.disconnect())}}});g.observe(m,{childList:!0,subtree:!0}),setTimeout(()=>g.disconnect(),5e3)}},500)}}})}).observe(document.body,{childList:!0,subtree:!0})};document.querySelectorAll(o).forEach(t=>{w(t)}),new MutationObserver(t=>{console.log("MutationObserver callback triggered.");for(const n of t)n.type==="childList"&&n.addedNodes.forEach(r=>{if(r.nodeType===Node.ELEMENT_NODE){const e=r;e.matches&&e.matches(o)?(console.log("Observer found matching textarea directly:",e),w(e)):e.querySelectorAll&&e.querySelectorAll(o).forEach(i=>{console.log("Observer found matching textarea within added node:",i),w(i)})}})}).observe(document.body,{childList:!0,subtree:!0}),$()}},I=(F=(D=globalThis.browser)==null?void 0:D.runtime)!=null&&F.id?globalThis.browser:globalThis.chrome;function L(c,...o){}const U={debug:(...c)=>L(console.debug,...c),log:(...c)=>L(console.log,...c),warn:(...c)=>L(console.warn,...c),error:(...c)=>L(console.error,...c)},A=class A extends Event{constructor(o,a){super(A.EVENT_NAME,{}),this.newUrl=o,this.oldUrl=a}};E(A,"EVENT_NAME",R("wxt:locationchange"));let P=A;function R(c){var o;return`${(o=I==null?void 0:I.runtime)==null?void 0:o.id}:bsky_alt_generator:${c}`}function B(c){let o,a;return{run(){o==null&&(a=new URL(location.href),o=c.setInterval(()=>{let s=new URL(location.href);s.href!==a.href&&(window.dispatchEvent(new P(s,a)),a=s)},1e3))}}}const S=class S{constructor(o,a){E(this,"isTopFrame",window.self===window.top);E(this,"abortController");E(this,"locationWatcher",B(this));E(this,"receivedMessageIds",new Set);this.contentScriptName=o,this.options=a,this.abortController=new AbortController,this.isTopFrame?(this.listenForNewerScripts({ignoreFirstEvent:!0}),this.stopOldScripts()):this.listenForNewerScripts()}get signal(){return this.abortController.signal}abort(o){return this.abortController.abort(o)}get isInvalid(){return I.runtime.id==null&&this.notifyInvalidated(),this.signal.aborted}get isValid(){return!this.isInvalid}onInvalidated(o){return this.signal.addEventListener("abort",o),()=>this.signal.removeEventListener("abort",o)}block(){return new Promise(()=>{})}setInterval(o,a){const s=setInterval(()=>{this.isValid&&o()},a);return this.onInvalidated(()=>clearInterval(s)),s}setTimeout(o,a){const s=setTimeout(()=>{this.isValid&&o()},a);return this.onInvalidated(()=>clearTimeout(s)),s}requestAnimationFrame(o){const a=requestAnimationFrame((...s)=>{this.isValid&&o(...s)});return this.onInvalidated(()=>cancelAnimationFrame(a)),a}requestIdleCallback(o,a){const s=requestIdleCallback((...h)=>{this.signal.aborted||o(...h)},a);return this.onInvalidated(()=>cancelIdleCallback(s)),s}addEventListener(o,a,s,h){var y;a==="wxt:locationchange"&&this.isValid&&this.locationWatcher.run(),(y=o.addEventListener)==null||y.call(o,a.startsWith("wxt:")?R(a):a,s,{...h,signal:this.signal})}notifyInvalidated(){this.abort("Content script context invalidated"),U.debug(`Content script "${this.contentScriptName}" context invalidated`)}stopOldScripts(){window.postMessage({type:S.SCRIPT_STARTED_MESSAGE_TYPE,contentScriptName:this.contentScriptName,messageId:Math.random().toString(36).slice(2)},"*")}verifyScriptStartedEvent(o){var y,N,w;const a=((y=o.data)==null?void 0:y.type)===S.SCRIPT_STARTED_MESSAGE_TYPE,s=((N=o.data)==null?void 0:N.contentScriptName)===this.contentScriptName,h=!this.receivedMessageIds.has((w=o.data)==null?void 0:w.messageId);return a&&s&&h}listenForNewerScripts(o){let a=!0;const s=h=>{if(this.verifyScriptStartedEvent(h)){this.receivedMessageIds.add(h.data.messageId);const y=a;if(a=!1,y&&(o!=null&&o.ignoreFirstEvent))return;this.notifyInvalidated()}};addEventListener("message",s),this.onInvalidated(()=>removeEventListener("message",s))}};E(S,"SCRIPT_STARTED_MESSAGE_TYPE",R("wxt:content-script-started"));let k=S;function W(){}function M(c,...o){}const _={debug:(...c)=>M(console.debug,...c),log:(...c)=>M(console.log,...c),warn:(...c)=>M(console.warn,...c),error:(...c)=>M(console.error,...c)};return(async()=>{try{const{main:c,...o}=v,a=new k("bsky_alt_generator",o);return await c(a)}catch(c){throw _.error('The content script "bsky_alt_generator" crashed on startup!',c),c}})()}();
bskyaltgenerator;
