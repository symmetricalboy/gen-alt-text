var bskyaltgenerator=function(){"use strict";var K=Object.defineProperty;var Q=(w,E,g)=>E in w?K(w,E,{enumerable:!0,configurable:!0,writable:!0,value:g}):w[E]=g;var x=(w,E,g)=>Q(w,typeof E!="symbol"?E+"":E,g);var V,$;function w(l){return l}const g=($=(V=globalThis.browser)==null?void 0:V.runtime)!=null&&$.id?globalThis.browser:globalThis.chrome,j={matches:["*://*.bsky.app/*"],main(){if(console.log("Bluesky Alt Text Generator loaded"),typeof window>"u"||typeof document>"u")return;const i=['textarea[aria-label="Alt text"]','textarea[placeholder*="alt"]','textarea[placeholder*="Alt"]','textarea[data-testid*="alt"]','[role="textbox"][aria-label*="alt" i]'].join(","),s="gemini-alt-text-button",c='[data-testid="composer"]',h='input[type="file"][aria-label*="media" i]',p=c;let u={autoMode:!1,showToasts:!0};async function D(){try{const o=await g.storage.local.get(["autoMode","showToasts"]);o&&(u={...u,...o}),console.log("Loaded config:",u)}catch(o){console.error("Error loading config from storage:",o)}}D(),g.storage.onChanged.addListener((o,r)=>{if(r==="local"){let a=!1;o.autoMode&&(u.autoMode=o.autoMode.newValue,a=!0),o.showToasts&&(u.showToasts=o.showToasts.newValue,a=!0),a&&console.log("Updated config via storage listener:",u)}});const _=o=>{if(!(!o||o.length===0)){console.log(`Intercepted ${o.length} file(s)`);for(const r of o){if(!r.type.startsWith("image/")&&!r.type.startsWith("video/")){console.log(`Skipping non-media file: ${r.name} (${r.type})`);continue}const a=new FileReader;a.onload=t=>{var e;const n=(e=t.target)==null?void 0:e.result;typeof n=="string"?(console.log(`Read file ${r.name} (${r.type}), sending to background...`),g.runtime.sendMessage({type:"MEDIA_INTERCEPTED",payload:{filename:r.name,filetype:r.type,dataUrl:n,size:r.size}}).then(d=>{console.log("Background script responded to MEDIA_INTERCEPTED:",d)}).catch(d=>{console.error("Error sending MEDIA_INTERCEPTED message or receiving response:",d)}),u.showToasts&&F(`Captured ${r.name}`,"info",2e3)):console.error(`Failed to read file ${r.name} as Base64 Data URL.`)},a.onerror=t=>{console.error(`Error reading file ${r.name}:`,t)},a.readAsDataURL(r)}}},F=(o,r="info",a=5e3)=>{let t=document.getElementById("gemini-toast-container");t||(t=document.createElement("div"),t.id="gemini-toast-container",Object.assign(t.style,{position:"fixed",bottom:"20px",right:"20px",zIndex:"10000",display:"flex",flexDirection:"column",gap:"10px"}),document.body.appendChild(t));const n=document.createElement("div");Object.assign(n.style,{padding:"12px 16px",borderRadius:"6px",boxShadow:"0 2px 8px rgba(0, 0, 0, 0.15)",margin:"5px",minWidth:"200px",color:"#ffffff",fontSize:"14px",transition:"all 0.3s ease"});const e={success:"#1da882",error:"#e53935",warning:"#f59f0b",info:"#007eda"};n.style.backgroundColor=e[r]||e.info,n.textContent=o;const d=document.createElement("span");d.textContent="×",Object.assign(d.style,{marginLeft:"8px",cursor:"pointer",float:"right",fontWeight:"bold"}),d.onclick=()=>{n.parentNode===t&&t.removeChild(n)},n.appendChild(d),t.appendChild(n),setTimeout(()=>{n.parentNode===t&&t.removeChild(n)},a)},X=o=>{console.log("[findMediaElement - Simplified] Searching for media in container:",o);const r=t=>{if(!t)return!1;const n=t.getBoundingClientRect();return n.width>0&&n.height>0&&t.offsetParent!==null},a=['[data-testid="imagePreview"] img[src]','[data-testid="images"] img[src]','[data-testid="videoPreview"] video[src]','[data-testid="videos"] video[src]','[data-testid="videoPreview"] video source[src]','[data-testid="videos"] video source[src]','img[src]:not([alt*="avatar" i]):not([src*="avatar"])',"video[src]","video source[src]"];for(const t of a){const n=o.querySelector(t);if(n instanceof HTMLSourceElement){const e=n.closest("video");if(e&&r(e))return console.log(`[findMediaElement - Simplified] Found video via source selector: ${t}`,e),e;console.warn(`[findMediaElement - Simplified] Found source tag but parent video hidden/invalid: ${t}`,n);continue}if(n&&r(n))return console.log(`[findMediaElement - Simplified] Found media via direct selector: ${t}`,n),n;n&&console.warn(`[findMediaElement - Simplified] Media found but hidden/too small with selector: ${t}`,n)}return console.error("[findMediaElement - Simplified] FAILED: No suitable media found using direct selectors."),null};async function Y(o){if(!o||!o.src)return console.warn("[getMediaAsDataUrl] Invalid element or src"),null;const r=o.src;if(r.startsWith("data:"))return console.log("[getMediaAsDataUrl] Source is already Data URL"),r;if(r.startsWith("blob:")||r.startsWith("http")){console.log("[getMediaAsDataUrl] Fetching source URL:",r);try{const a=await fetch(r);if(!a.ok)throw new Error(`Failed to fetch media URL: ${a.statusText} (${a.status})`);const t=await a.blob();return console.log("[getMediaAsDataUrl] Fetched blob, type:",t.type),new Promise((n,e)=>{const d=new FileReader;d.onloadend=()=>{typeof d.result=="string"?(console.log("[getMediaAsDataUrl] Blob converted to base64 Data URL"),n(d.result)):e(new Error("Blob reader result was not a string."))},d.onerror=f=>{console.error("[getMediaAsDataUrl] FileReader error:",f),e(new Error("FileReader error reading blob."))},d.readAsDataURL(t)})}catch(a){return console.error("[getMediaAsDataUrl] Error fetching or converting URL:",a),null}}else return console.warn("[getMediaAsDataUrl] Unhandled URL scheme:",r),null}function P(o){if(o.dataset.geminiButtonAdded==="true")return;console.log("[addGenerateButton] Starting for textarea:",o);const r=G(o);if(!r){console.error("[addGenerateButton] Could not find the context container (composePostView, Add alt text, or Video settings) for the textarea. Button not added.");return}console.log("[addGenerateButton] Found context container for textarea:",r);let a=null;if(r.matches('[aria-label="Video settings"]')){if(console.log('[addGenerateButton] Context is "Video settings", searching document for [data-testid="composePostView"]...'),a=document.querySelector('[data-testid="composePostView"]'),!a){console.error('[addGenerateButton] Context is "Video settings", but failed to find [data-testid="composePostView"] in the document for media search.');return}console.log('[addGenerateButton] Context is "Video settings", found composePostView in document for media search:',a)}else a=r,console.log("[addGenerateButton] Context is composePostView or Add alt text, targeting context container for media search:",a);if(a.querySelector(`#${s}`)){console.log("[addGenerateButton] Button already exists in the media search container, marking textarea and skipping UI creation."),o.dataset.geminiButtonAdded="true";return}const t=o.parentElement;if(!t){console.error("[addGenerateButton] Could not find a suitable attach point (parentElement) for the button UI near the textarea.");return}const n=document.createElement("div");Object.assign(n.style,{display:"flex",alignItems:"center",gap:"8px",marginTop:"4px",justifyContent:"flex-end"});const e=document.createElement("button");e.id=s,e.title="Generate Alt Text",e.innerHTML='<svg width="20" height="20" viewBox="-5 -10 128 128" xmlns="http://www.w3.org/2000/svg"><path d="M 35.746,4 C 20.973,4 9,15.973 9,30.746 V 77.254 C 9,92.027 20.973,104 35.746,104 H 82.254 C 97.027,104 109,92.027 109,77.254 V 30.746 C 109,15.973 97.027,4 82.254,4 Z m -19.77,26.746 c 0,-10.918 8.8516,-19.77 19.77,-19.77 h 46.508 c 10.918,0 19.77,8.8516 19.77,19.77 v 46.508 c 0,10.918 -8.8516,19.77 -19.77,19.77 H 35.746 c -10.918,0 -19.77,-8.8516 -19.77,-19.77 z m 45.609,0.37891 c -1.082,-2.1055 -4.0898,-2.1055 -5.1719,0 l -4.3242,8.4219 c -1.668,3.2383 -4.3047,5.875 -7.543,7.543 l -8.4219,4.3242 c -2.1055,1.082 -2.1055,4.0898 0,5.1719 l 8.4219,4.3242 c 3.2383,1.668 5.875,4.3047 7.543,7.543 l 4.3242,8.4219 c 1.082,2.1055 4.0898,2.1055 5.1719,0 l 4.3242,-8.4219 c 1.668,-3.2383 4.3047,-5.875 7.543,-7.543 l 8.4219,-4.3242 c 2.1055,-1.082 2.1055,-4.0898 0,-5.1719 l -8.4219,-4.3242 c -3.2383,-1.668 -5.875,-4.3047 -7.543,-7.543 z" fill="#323248" stroke="none" /></svg>',Object.assign(e.style,{marginLeft:"8px",padding:"4px",cursor:"pointer",border:"1px solid #ccc",borderRadius:"4px",backgroundColor:"#f0f0f0",display:"flex",alignItems:"center",justifyContent:"center"}),e.style.setProperty("visibility","visible","important"),e.style.setProperty("z-index","9999","important"),e.style.setProperty("position","relative","important");const d=e.innerHTML,f=document.createElement("label");f.className="gemini-auto-toggle",f.title="Auto-generate alt text when media is added",Object.assign(f.style,{display:"flex",alignItems:"center",fontSize:"12px",cursor:"pointer"});const v=document.createElement("input");v.type="checkbox",v.style.margin="0 4px 0 0",v.checked=u.autoMode,v.addEventListener("change",async m=>{if(m.target instanceof HTMLInputElement){u.autoMode=m.target.checked;try{await g.storage.local.set({...u,autoMode:u.autoMode}),console.log("Saved autoMode setting:",u.autoMode)}catch(A){console.error("Error saving autoMode setting:",A)}}}),f.appendChild(v),f.appendChild(document.createTextNode("Auto")),n.appendChild(e),n.appendChild(f);const y=async()=>{if(e.innerHTML="",e.textContent="Finding Media...",e.disabled=!0,!a){console.error("[generateAltText] mediaSearchContainer is null! Cannot search for media."),e.textContent="Error: Internal",setTimeout(()=>{e.innerHTML=d,e.disabled=!1},3e3);return}console.log("[generateAltText] Searching for media within determined media search container:",a);const m=X(a);if(console.log("[generateAltText] Media element found in search container:",m),!m||!(m instanceof HTMLImageElement||m instanceof HTMLVideoElement)){console.error("[generateAltText] Could not find valid media element."),e.textContent="Error: No Media",setTimeout(()=>{e.innerHTML=d,e.disabled=!1},2e3);return}e.textContent="Processing Media...";const A=await Y(m);if(!A){console.error("[generateAltText] Failed to get media as Data URL."),e.textContent="Error: Process Fail",setTimeout(()=>{e.innerHTML=d,e.disabled=!1},3e3);return}const q=m.tagName==="VIDEO";console.log(`[generateAltText] Got ${q?"Video":"Image"} as Data URL (length: ${A.length})`);try{console.log("[generateAltText] Connecting to background..."),e.textContent="Connecting...";const M=g.runtime.connect({name:"altTextGenerator"});console.log("[generateAltText] Connection established."),e.textContent="Generating...",M.onMessage.addListener(b=>{console.log("[generateAltText] Msg from background:",b);let T="",k=!1;if(b.altText)o.value=b.altText,o.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),T="✓ Done",u.showToasts&&F("Alt text generated! Please review.","success");else if(b.error){const B=typeof b.error=="string"?b.error:"Unknown error";T=`Error: ${B.substring(0,20)}...`,k=!0,u.showToasts&&F(`Error: ${B}`,"error")}else T="Msg Format Err",k=!0,console.error("[generateAltText] Unexpected message format:",b);e.textContent=T,setTimeout(()=>{e.innerHTML=d,e.disabled=!1},k?3e3:1500);try{M.disconnect()}catch{}}),M.onDisconnect.addListener(()=>{const b=g.runtime.lastError;console.error("[generateAltText] Port disconnected.",b||"(No error info)");const T=e.textContent;T&&!T.includes("Done")&&!T.includes("Error")&&(e.textContent="Disconnect Err",setTimeout(()=>{e.innerHTML=d,e.disabled=!1},3e3))}),console.log("[generateAltText] Sending message..."),M.postMessage({action:"generateAltText",imageUrl:A,isVideo:q}),console.log("[generateAltText] Message sent.")}catch(M){console.error("[generateAltText] Connect/Post error:",M),e.textContent="Connect Error",setTimeout(()=>{e.innerHTML=d,e.disabled=!1},2e3)}};e.onclick=async m=>{m.preventDefault(),m.stopPropagation(),console.log("[addGenerateButton] Button clicked"),await y()},t.insertAdjacentElement("afterend",n),o.dataset.geminiButtonAdded="true",console.log("[addGenerateButton] Button UI setup complete and attached.")}function G(o){console.log("[findComposerContainer] Searching from:",o);const r=['[data-testid="composePostView"]','[aria-label="Add alt text"]','[aria-label="Video settings"]'];for(const a of r){const t=o.closest(a);if(t&&t.contains(o))return console.log("[findComposerContainer] Found valid container via specific selector:",a,t),t}return console.error("[findComposerContainer] Failed to find any container using specific selectors:",r.join(", ")),null}const J=()=>{new MutationObserver(r=>{if(u.autoMode)for(const a of r)a.type==="childList"&&a.addedNodes.forEach(t=>{if(t instanceof HTMLElement){const n=e=>{var d;if((e.tagName==="IMG"||e.tagName==="VIDEO")&&!((d=e.getAttribute("alt"))!=null&&d.includes("avatar"))){console.log("Auto-gen: Media element detected:",e);const f=G(e);f&&setTimeout(()=>{const v=f.querySelector(i);if(v){P(v);const y=f.querySelector(`#${s}`);y&&!y.disabled&&(console.log("Auto-generating alt text for:",e),y.click())}else console.log("Auto-gen: No alt text field found yet for media:",e)},500)}};n(t),t.querySelectorAll("img, video").forEach(n)}})}).observe(document.body,{childList:!0,subtree:!0}),console.log("Media observer started for auto-generation.")};document.querySelectorAll(i).forEach(P),new MutationObserver(o=>{console.log("Main observer triggered.");for(const r of o)r.type==="childList"&&r.addedNodes.forEach(a=>{a instanceof Element&&(a.matches(i)&&P(a),a.querySelectorAll(i).forEach(P))})}).observe(document.body,{childList:!0,subtree:!0}),J();const O=o=>{console.log("[attachMediaListeners] Attaching to:",o);const r=o.querySelector(h),a=o.closest(p)||(o instanceof HTMLElement?o:null),t=r;t&&!t.dataset.mediaListenerAttached?(t.addEventListener("change",e=>{e.target instanceof HTMLInputElement&&(console.log("[attachMediaListeners] File input CHANGED"),_(e.target.files))}),t.dataset.mediaListenerAttached="true",console.log("[attachMediaListeners] Change listener attached to file input.")):t?console.log("[attachMediaListeners] Change listener already attached to file input."):console.warn("[attachMediaListeners] Could not find file input using selector:",h,"within:",o);const n=a;n&&!n.dataset.dropListenerAttached?(n.addEventListener("dragover",e=>{e.preventDefault(),e.stopPropagation()}),n.addEventListener("drop",e=>{var d;e.preventDefault(),e.stopPropagation(),console.log("[attachMediaListeners] DROP event detected"),(d=e.dataTransfer)!=null&&d.files&&_(e.dataTransfer.files)}),n.dataset.dropListenerAttached="true",console.log("[attachMediaListeners] Drop/Dragover listeners attached to drop zone:",n)):n?console.log("[attachMediaListeners] Drop/Dragover listeners already attached."):console.warn("[attachMediaListeners] Could not find drop zone using selector:",p)},H=()=>{console.log("Setting up observer for composer elements..."),new MutationObserver(r=>{for(const a of r)a.type==="childList"&&a.addedNodes.forEach(t=>{t instanceof Element&&(t.matches(c)&&(console.log("Composer added directly:",t),O(t)),t.querySelectorAll(c).forEach(n=>{console.log("Composer found via querySelectorAll:",n),O(n)}))})}).observe(document.body,{childList:!0,subtree:!0}),console.log("Composer observer started."),document.querySelectorAll(c).forEach(O)};document.readyState==="complete"||document.readyState==="interactive"?H():document.addEventListener("DOMContentLoaded",H)}};function L(l,...i){}const z={debug:(...l)=>L(console.debug,...l),log:(...l)=>L(console.log,...l),warn:(...l)=>L(console.warn,...l),error:(...l)=>L(console.error,...l)},I=class I extends Event{constructor(i,s){super(I.EVENT_NAME,{}),this.newUrl=i,this.oldUrl=s}};x(I,"EVENT_NAME",U("wxt:locationchange"));let R=I;function U(l){var i;return`${(i=g==null?void 0:g.runtime)==null?void 0:i.id}:bsky_alt_generator:${l}`}function W(l){let i,s;return{run(){i==null&&(s=new URL(location.href),i=l.setInterval(()=>{let c=new URL(location.href);c.href!==s.href&&(window.dispatchEvent(new R(c,s)),s=c)},1e3))}}}const C=class C{constructor(i,s){x(this,"isTopFrame",window.self===window.top);x(this,"abortController");x(this,"locationWatcher",W(this));x(this,"receivedMessageIds",new Set);this.contentScriptName=i,this.options=s,this.abortController=new AbortController,this.isTopFrame?(this.listenForNewerScripts({ignoreFirstEvent:!0}),this.stopOldScripts()):this.listenForNewerScripts()}get signal(){return this.abortController.signal}abort(i){return this.abortController.abort(i)}get isInvalid(){return g.runtime.id==null&&this.notifyInvalidated(),this.signal.aborted}get isValid(){return!this.isInvalid}onInvalidated(i){return this.signal.addEventListener("abort",i),()=>this.signal.removeEventListener("abort",i)}block(){return new Promise(()=>{})}setInterval(i,s){const c=setInterval(()=>{this.isValid&&i()},s);return this.onInvalidated(()=>clearInterval(c)),c}setTimeout(i,s){const c=setTimeout(()=>{this.isValid&&i()},s);return this.onInvalidated(()=>clearTimeout(c)),c}requestAnimationFrame(i){const s=requestAnimationFrame((...c)=>{this.isValid&&i(...c)});return this.onInvalidated(()=>cancelAnimationFrame(s)),s}requestIdleCallback(i,s){const c=requestIdleCallback((...h)=>{this.signal.aborted||i(...h)},s);return this.onInvalidated(()=>cancelIdleCallback(c)),c}addEventListener(i,s,c,h){var p;s==="wxt:locationchange"&&this.isValid&&this.locationWatcher.run(),(p=i.addEventListener)==null||p.call(i,s.startsWith("wxt:")?U(s):s,c,{...h,signal:this.signal})}notifyInvalidated(){this.abort("Content script context invalidated"),z.debug(`Content script "${this.contentScriptName}" context invalidated`)}stopOldScripts(){window.postMessage({type:C.SCRIPT_STARTED_MESSAGE_TYPE,contentScriptName:this.contentScriptName,messageId:Math.random().toString(36).slice(2)},"*")}verifyScriptStartedEvent(i){var p,u,D;const s=((p=i.data)==null?void 0:p.type)===C.SCRIPT_STARTED_MESSAGE_TYPE,c=((u=i.data)==null?void 0:u.contentScriptName)===this.contentScriptName,h=!this.receivedMessageIds.has((D=i.data)==null?void 0:D.messageId);return s&&c&&h}listenForNewerScripts(i){let s=!0;const c=h=>{if(this.verifyScriptStartedEvent(h)){this.receivedMessageIds.add(h.data.messageId);const p=s;if(s=!1,p&&(i!=null&&i.ignoreFirstEvent))return;this.notifyInvalidated()}};addEventListener("message",c),this.onInvalidated(()=>removeEventListener("message",c))}};x(C,"SCRIPT_STARTED_MESSAGE_TYPE",U("wxt:content-script-started"));let N=C;function ee(){}function S(l,...i){}const Z={debug:(...l)=>S(console.debug,...l),log:(...l)=>S(console.log,...l),warn:(...l)=>S(console.warn,...l),error:(...l)=>S(console.error,...l)};return(async()=>{try{const{main:l,...i}=j,s=new N("bsky_alt_generator",i);return await l(s)}catch(l){throw Z.error('The content script "bsky_alt_generator" crashed on startup!',l),l}})()}();
bskyaltgenerator;
